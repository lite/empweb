# ЧТО ЭТО?

Интерфейс для работы с базой данных и бизнес логика уровня данных
для проекта `Empweb`.
Приложение использует 2 базы данных на СУБД `Postgres`.

1. `emp`      — основная база данных приложения,
в ней хранятся все данные о пользователях и объектах.
2. `ejabberd` — база данных приложения `ejabberd`, `empdb`
использует ее для создания пользователей в `ejabberd`.

# СТРУКТУРА КАТАЛОГОВ
    .
    ├──[ebin]                                   # бинарные файлы приложения;
    ├──[include]                                # заголовочные файлы приложения;
    ├──[priv]                                   # вспомогательные файлы;
    │   ├──[old]                                # устаревшие версии;
    │   └──[sql]                                # вспомогательные файлы БД;
    │       ├──[create]                         # исходники для создания БД;
    │       │   ├──[ejabberd]                   # исходники БД `ejabberd`;
    │       │   │   ├── ejabberd_indexes.sql    # индексы БД `ejabberd`;
    │       │   │   ├── ejabberd_initdata.sql   # начальные данные БД `ejabberd`;
    │       │   │   ├── ejabberd_procedures.sql # триггеры БД `ejabberd`;
    │       │   │   └── ejabberd_scheme.sql     # схема БД `ejabberd`;
    │       │   │
    │       │   ├──[emp]                        # исходные файлы БД `emp`;
    │       │   │   ├── emp_indexes.sql         # индексы БД `emp`;
    │       │   │   ├── emp_initdata.sql        # начальные данные БД `emp`;
    │       │   │   ├── emp_procedures.sql      # процедуры и триггеры БД `emp`;
    │       │   │   └── emp_scheme.sql          # схема БД `emp`;
    │       │   └── redb.sh                     # скрипт создания БД;
    │       ├──[dumps]                          # дампы БД `emp` и `ejabberd`;
    │       │   └── mkdump.sh                   # скрипт дампов БД;
    │       └── emp_dbchange.sql                # список изменений БД `emp`;
    │
    ├──[src]                    # ИСХОДНИКИ ПРИЛОЖЕНИЯ;
    │   ├──[biz]                # бизнес-логика;
    │   ├──[daowp]              # обертка логики БД;
    │   ├──[dao]                # взаимодействие с БД;
    │   ├── empdb.app.src       # файл ресурсов приложения;
    │   ├── empdb_app.erl       # модуль, стартующий приложение;
    │   ├── empdb_base62.erl    # кодирование в `base62` [НЕ ИСПОЛЬЗУЕТСЯ!];
    │   ├── empdb_biz.erl       # общие функции бизнес-логики,
    │   │                       #   `gen_server` используется как таймер;
    │   ├── empdb_convert.erl   # функции конвертации различных типов;
    │   ├── empdb_dao.erl       # общие функции взаимодействия с БД,
    │   │                       #   содержит реализация простейшей ORM;
    │   ├── empdb.erl           # пустой модуль, [НЕ ИСПОЛЬЗУЕТСЯ!];
    │   ├── empdb_orm_util.erl  # вспомогательный модуль для `empdb_dao.erl`
    │   │                       #   предполагается, что часть функция будут
    │   │                       #   перенесены сюда;
    │   ├── empdb_suggest.erl   # модуль генерации "похожих" строк,
    │   │                       #   используется для предложения
    │   │                       #   новых имен пользователей.
    │   ├── empdb_sup.erl       # модуль наблюдения;
    │   ├── empdb_timer.erl     # таймер, различные действия раз в какое-то время,
    │   │                       #   может быть заменен стандартными функциями
    │   │                       #   `timer:apply_interval/4`;
    │   ├── empdb_uuid.erl      # модуль генерации uuid.
    │   └── README.md           # описание исходников приложения.
    │
    ├── CHANGELOG.md                            # список ключевых изменений;
    ├── ctl.sh                                  # скрипт запуска приложения;
    ├── empdb.config                            # конфигурация приложения;
    ├── Makefile                                # правила сборки приложения;
    ├── README.md                               # описание приложения;
    ├── rebar                                   # сборщик приложения;
    └── rebar.config                            # конфигурация сборщика.

# ЧТО НУЖНО ДЛЯ РАБОТЫ?

Необходимы:
*   `erlang`;
*   `make`;
*   запущенный сервер `postgresql`.
Для нормальной библиотеки работы нужны:
*   `psqlcp`      — как пул соединения с СУБД `Postgres`;
*   `nodectl`     — управление узлом если `empdb` запущена как ОТП-приложение;
*   `term_cache`  — как инструмент кеширования.
Для нормальной работы `psqlcp` нужны:
*   `poolboy`     — библиотека для построения абстрактных пулов;
*   `epgsql`      — библиотека для работы СУБД `Postgres`;
Для создания баз в начальном состоянии скриптом `./priv/sql/create/redb.sh`
потребуются утилиты:
*   `psql`            — для обращения к базе данных из консоли;
*   `cat`, `grep`, `tail` — для просмотра и поиска ошибок при создании.
Для корректного создания дампов скриптом `./priv/sql/dumps/mkdump.sh`
баз данных потребуются утилиты:
*   `pg_dump`     — для непосредственного создания дампа;
*   `bzip2`       — для сжатия дампов.

На данный момент необходимые приложения располагаются в папке `../` .
Для того, чтобы собрать приложение нужно отредактировать файл `./rebar.config`
соответствующим образом и запустить

    ./make

или набрать последовательность команд:

    ./rebar check-deps      # проверка необходимости зависимостей;
    ./rebar get-deps        # скачивание зависимостей;
    ./rebar update-deps     # обновление зависимостей (осторожно с версиями);
    ./rebar compile         # компиляция приложения.

# КАК ЭТО ИСПОЛЬЗОВАТЬ

Перед использованием приложения нужно убедиться,
что создана соответствующая база данных.
Схема базы данных и ее окружение лежат в папке `./priv/sql/create`.
Для пересоздания схем баз данных и заполнения их начальными данными
нужно набрать команду `./priv/sql/create/redb.sh`

## КАК ОТДЕЛЬНОЕ ПРИЛОЖЕНИЕ

Запускать приложение `empdb` можно как отдельный ОТП-узел.
Для этого требуется выполнить:

*   `ctl.sh start`  — для запуска узла в интерактивном режиме;
*   `ctl.sh startd` — для запуска узла в фоне.

Для остановки узла выполнить:

*   `ctl.sh stop`.

## КАК БИБЛИОТЕКУ

В рамках текущего проекта `empdb` используется как библиотека.
Для этого нужно, чтобы бинарные файлы `empdb` (`./ebin`)
были занесены в путь поиска исполняемых файлов.
Возможно повторное использование некоторых компонент.
Например, очень хорошо, было бы вынести молуль `empdb_dao`
и связанные с ним в отдельное ОТП-приложение.

# TODO

*   Комментировать код;
*   Разделить некоторые модули по моделям (таблицам базы данных);
*   Вынести модуль `empdb_dao` и связанные с ним в отдельное ОТП-приложение.

