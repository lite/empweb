# Что это?

Интерфейс для работы с базой данных и бизнесс логика уровня данных
для проекта Empire.
Приложение использует 2 базы данных на СУБД Postgres.
1. emp      --- основная база данных приложения,
                в ней хранятся все данные о пользователях 
                и объектах.
2. ejabberd --- база данных приложения ejabberd, empdb использует ее для
                создания пользователей в ejabberd.

# Структура каталогов
    .
    ├──[ebin]                                   # скомпилированные файлы приложения
    ├──[include]                                # заголовочные файлы приложения
    ├──[priv]                                   # вспомогательные файлы
    │   ├──[old]                                # устаревшие версии, могут быть полезны
    │   └──[sql]                                # вспомогательные файлы бд
    │       ├──[create]                         # исходные файлы для создания бд
    │       │   ├──[ejabberd]                   # исходные файлы бд ejabberd
    │       │   │   ├── ejabberd_indexes.sql    # индексы бд ejabberd
    │       │   │   ├── ejabberd_initdata.sql   # начальные данные бд ejabberd
    │       │   │   ├── ejabberd_procedures.sql # процедуры и триггеры бд ejabberd
    │       │   │   └── ejabberd_scheme.sql     # схема бд ejabberd
    │       │   ├──[emp]                        # исходные файлы бд emp
    │       │   │   ├── emp_indexes.sql         # индексы бд emp
    │       │   │   ├── emp_initdata.sql        # начальные данные бд emp
    │       │   │   ├── emp_procedures.sql      # процедуры и триггеры бд emp
    │       │   │   └── emp_scheme.sql          # схема бд emp
    │       │   └── redb.sh                     # скрипт пересоздающий бд emp и ejabberd
    │       ├──[dumps]                          # дампы бд emp и ejabberd
    │       │   └── mkdump.sh                   # скрипт создающий дампы бд emp и ejabberd
    │       └── emp_dbchange.sql                # список изменений бд emp
    ├──[src]                                    # файлы исходных кодов приложения
    │   ├──[biz]                                # бизнесс-логика
    │   └──[dao]                                # взаимодействие с базой данных
    ├── CHANGELOG.md                            # список ключевых изменений
    ├── ctl.sh                                  # скрипт запуска приложения
    ├── empdb.config                            # конфигурация приложения
    ├── Makefile                                # правила сборки приложения
    ├── README.md                               # описание приложения
    ├── rebar                                   # сборщик приложения
    └── rebar.config                            # конфигурация сборщика приложения

# Что нужно для работы?

Жизнено необходимы:
*   `erlang`;
*   `make`;
*   запущенный сервер postgresql.
Для нормальной библиотеки работы нужны:
*   `psqlcp`      --- как пулл соединения с СУБД Postgres;
*   `nodectl`     --- управление нодой если empdb запущена как ОТП-приложение;
*   `term_cache`  --- как инструмент кеширования.
Для нормальной работы psqlcp нужны:
*   `poolboy`     --- библиотека для построения абстрактных пуллов;
*   `epgsql`      --- библиотека для работы СУБД Postgres;
Для создания баз в начальном состоянии скриптом `./priv/sql/create/redb.sh`
потребуются утилиты:
*   `psql`            --- для обращения к базе данных из консоли;
*   cat, grep, tail --- для просмотра и поиска ошибок при создании.
Для корректоного создания дампов скриптом `./priv/sql/dumps/mkdump.sh`
баз данных потребуются утилиты:
*   `pg_dump`     --- для непосредственного создания дампа;
*   `bzip2`       --- для cжатия дампов.

На данный момент необходимые приложения располагаются в папке `../` .
Для того, чтобы собрать приложение нужно отредактировать файл `./rebar.config`
cоответсвующим образом и запустить
    ./make
или набрать последовательность команд:
    ./rebar check-deps      # проверка необходимости зависимостей;
    ./rebar get-deps        # скачивание зависимостей;
    ./rebar update-deps     # обновление зависимостей (осторожно с версиями);
    ./rebar compile         # компиляция приложения.

# Как это использовать

Перед использованием приложения нужно убедиться, 
что создана соответвующая база данных.
Схема базы данных и ее окружение лежат в папке `./priv/sql/create`.
Для пересоздания схем баз данных и заполнения их начальными данными 
нужно набрать команду `./priv/sql/create/redb.sh`

## Как отдельное приложение

Запускать приложение empdb можно как отдельную ОТП-ноду.
Для этого требуется выполнить:
*   ctl.sh start  --- для запуска ноды в интерактивном режиме;
*   ctl.sh startd --- для запуска ноды в фоне.
Для остановки ноды выполнить:
*   ctl.sh stop;

## Как библиотеку

В рамках текущего проекта empdb используется как библиотека.
Для этого нужно, чтобы бинарные файлы empdb (./ebin) были занесены в путь
поиска исполняемых файлов.
Возможно повторное использование некоторых компонент.
Например, очень хорошо, было бы вынести молуль `empdb_dao`
и связанные с ним в отдельное ОТП-приложение.

# TODO

*   Коментировать код;
*   Разделить некоторые модули по моделям (таблицам базы данных);
*   Вынести молуль `empdb_dao` и связанные с ним в отдельное ОТП-приложение.

